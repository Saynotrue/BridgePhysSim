<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Bridge Wind Simulation</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
        "three/examples/jsm/controls/OrbitControls": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/OrbitControls.js",
        "three/examples/jsm/controls/PointerLockControls": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/PointerLockControls.js"
      }
    }
  </script>
</head>

<body>
  <div id="windControl"
    style="position: absolute; top: 10px; left: 10px; z-index: 10; background-color: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
    <label for="windSlider">ðŸ’¨ ë°”ëžŒ ì„¸ê¸°: </label>
    <input type="range" id="windSlider" min="0" max="10" step="0.1" value="2"
      style="border-radius: 10px; background-color: white; height: 10px;">
    <input type="number" id="windValue" min="0" max="10" step="0.1" value="2"
      style="width: 50px; border-radius: 5px; border: 1px solid #ccc; padding: 5px; background-color: white;">
  </div>
  <button id="restartBtn"
    style="position: absolute; top: 67.5px; left: 10px; z-index: 10;  background-color: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">ìž¬ì‹œìž‘</button>
  <canvas id="canvas"></canvas>
  <script type="module">
    // PointerLock ì ìš© ì œì™¸: ìŠ¬ë¼ì´ë”, ìž…ë ¥ì°½, ë²„íŠ¼
    document.getElementById('windControl').addEventListener('click', e => e.stopPropagation());
    document.getElementById('windValue').addEventListener('click', e => e.stopPropagation());
    document.getElementById('restartBtn').addEventListener('click', e => e.stopPropagation());

    // í´ë¦­ ì‹œ PointerLockControls í™œì„±í™”
    document.body.addEventListener('click', () => {
      controls.lock();
    });

    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';
    import { PointerLockControls } from 'three/examples/jsm/controls/PointerLockControls';
    import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';
    import { createBridgeParts, parts, partBodies } from './boxes.js';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas') });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new PointerLockControls(camera, document.body);
    scene.add(controls.getObject());
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 10, 7.5);
    scene.add(light);

    const restartBtn = document.getElementById('restartBtn');

    const windSlider = document.getElementById('windSlider');
    const windValue = document.getElementById('windValue');

    let windStrength = parseFloat(windSlider.value);

    // ìŠ¬ë¼ì´ë” ë³€ê²½ â†’ ìž…ë ¥ì°½ë„ ì—…ë°ì´íŠ¸
    windSlider.addEventListener('input', () => {
      windStrength = parseFloat(windSlider.value);
      windValue.value = windSlider.value;
    });

    // ìž…ë ¥ì°½ ì§ì ‘ ìˆ˜ì • â†’ ìŠ¬ë¼ì´ë”ë„ ë°˜ì˜
    windValue.addEventListener('input', () => {
      windStrength = parseFloat(windValue.value);
      windSlider.value = windValue.value;
    });

    // ìž¬ì‹œìž‘ í•¨ìˆ˜
    function restartSimulation() {
      for (let i = 0; i < partBodies.length; i++) {
        const body = partBodies[i];
        const x = i * 1.2 - 1.2;
        body.position.set(x, 1, 0);
        body.velocity.set(0, 0, 0);
        body.angularVelocity.set(0, 0, 0);
        body.quaternion.set(0, 0, 0, 1);
      }

      // ì¹´ë©”ë¼ ìœ„ì¹˜ ì´ˆê¸°í™”
      camera.position.set(0, 2, 5);

      // í¬ì¸í„°ë½ ì»¨íŠ¸ë¡¤ì˜ ë‚´ë¶€ ë°©í–¥ ì´ˆê¸°í™”
      const camObj = controls.getObject();
      camObj.rotation.set(0, 0, 0); // pitch/yaw ì´ˆê¸°í™”
    }

    const keyState = {};
    document.addEventListener('keydown', e => {
      keyState[e.code] = true;

      if (e.code === 'KeyR') {
        restartSimulation();
      }
    });
    document.addEventListener('keyup', e => keyState[e.code] = false);

    function updateCameraPosition() {
      const speed = 0.1;
      const direction = new THREE.Vector3();

      if (keyState['KeyS']) direction.z -= 0.5;
      if (keyState['KeyW']) direction.z += 0.5;
      if (keyState['KeyA']) direction.x -= 0.5;
      if (keyState['KeyD']) direction.x += 0.5;
      if (keyState['KeyQ']) direction.y += 0.5;
      if (keyState['KeyE']) direction.y -= 0.5;

      if (direction.lengthSq() === 0) return; // ì´ë™ ì—†ìŒ

      direction.normalize();

      // ì¹´ë©”ë¼ ë°©í–¥ ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
      const moveVector = new THREE.Vector3();
      controls.getDirection(moveVector);
      moveVector.y = 0;
      moveVector.normalize();

      const rightVector = new THREE.Vector3();
      rightVector.crossVectors(moveVector, camera.up).normalize();

      const upVector = new THREE.Vector3(0, 1, 0); // ìœ„ìª½ ë°©í–¥

      const finalMove = new THREE.Vector3();
      finalMove.addScaledVector(moveVector, direction.z);   // ì•žìœ¼ë¡œ/ë’¤ë¡œ
      finalMove.addScaledVector(rightVector, direction.x);  // ì¢Œìš°
      finalMove.addScaledVector(upVector, direction.y);     // ìœ„ì•„ëž˜ ì¶”ê°€

      finalMove.normalize();
      controls.getObject().position.add(finalMove.multiplyScalar(speed));
    }

    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
    restartBtn.addEventListener('click', restartSimulation);

    const world = new CANNON.World({
      gravity: new CANNON.Vec3(0, -9.82, 0),
    });

    const groundBody = new CANNON.Body({
      mass: 0,
      shape: new CANNON.Plane(),
    });
    groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0); // ë°”ë‹¥ì„ XZ í‰ë©´ìœ¼ë¡œ íšŒì „
    world.addBody(groundBody);

    const groundMesh = new THREE.Mesh(
      new THREE.PlaneGeometry(100, 100),
      new THREE.MeshStandardMaterial({ color: 0x808080 })
    );
    groundMesh.rotation.x = -Math.PI / 2;
    scene.add(groundMesh);

    camera.position.set(0, 2, 5);

    const clock = new THREE.Clock();

    createBridgeParts(scene, world);

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();

      updateCameraPosition();

      // ë Œë”ë§
      renderer.render(scene, camera);

      const windStrength = parseFloat(windSlider.value);
      const windForce = new CANNON.Vec3(-windStrength, 0, 0);
      partBodies.forEach((body) => {
        body.applyForce(windForce, body.position);
      });

      world.step(1 / 60, delta, 3);

      for (let i = 0; i < parts.length; i++) {
        parts[i].position.copy(partBodies[i].position);
        parts[i].quaternion.copy(partBodies[i].quaternion);
      }

      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>

</html>
